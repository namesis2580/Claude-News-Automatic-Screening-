import os
import json
import smtplib
import feedparser
import anthropic
import traceback
import re
import unicodedata
from datetime import datetime, timedelta
from pathlib import Path

# ============================================================
# [0] ìœ í‹¸ë¦¬í‹°
# ============================================================

DATA_DIR = Path("data")
DATA_DIR.mkdir(exist_ok=True)
HISTORY_FILE = DATA_DIR / "report_history.json"

def forensic_clean(text: str, var_name: str) -> str:
    if text is None:
        return ""
    text = str(text)
    text = unicodedata.normalize("NFKC", text)
    text = text.replace("\xa0", "").replace("\u200b", "")
    try:
        text = text.encode("ascii", "ignore").decode("ascii")
    except Exception:
        pass
    text = text.strip()
    if "PASSWORD" in var_name.upper() or "KEY" in var_name.upper():
        print(f"  [OK] {var_name}: (hidden) [len={len(text)}]")
    else:
        print(f"  [OK] {var_name}: '{text[:40]}...' [len={len(text)}]")
    return text

def clean_rss_text(text: str) -> str:
    if text is None:
        return ""
    text = str(text)
    text = unicodedata.normalize("NFKC", text)
    text = re.sub(r"<[^>]+>", "", text)
    text = re.sub(r"\s+", " ", text)
    return text.strip()

def clean_report_body(text: str) -> str:
    if text is None:
        return ""
    text = str(text)
    text = unicodedata.normalize("NFKC", text)
    text = text.replace("\xa0", " ")
    return text.strip()

def load_history() -> dict:
    if HISTORY_FILE.exists():
        with open(HISTORY_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    return {"daily": [], "weekly": [], "monthly": [], "quarterly": [], "semi_annual": [], "annual": []}

def save_history(history: dict):
    with open(HISTORY_FILE, "w", encoding="utf-8") as f:
        json.dump(history, f, ensure_ascii=False, indent=2)

# ============================================================
# [1] í™˜ê²½ë³€ìˆ˜
# ============================================================

ANTHROPIC_API_KEY = forensic_clean(os.environ.get("ANTHROPIC_API_KEY", ""), "ANTHROPIC_API_KEY")
EMAIL_USER = forensic_clean(os.environ.get("EMAIL_USER", ""), "EMAIL_USER")
EMAIL_PASSWORD = forensic_clean(os.environ.get("EMAIL_PASSWORD", ""), "EMAIL_PASSWORD")
EMAIL_RECEIVER = forensic_clean(os.environ.get("EMAIL_RECEIVER", ""), "EMAIL_RECEIVER")
SMTP_SERVER = "smtp.naver.com"

# ============================================================
# [2] RSS ìˆ˜ì§‘
# ============================================================

RSS_URLS = {
    "Yahoo Finance": "https://finance.yahoo.com/news/rssindex",
    "Investing.com": "https://www.investing.com/rss/news.rss",
    "Google News (Biz)": "https://news.google.com/rss/headlines/section/topic/BUSINESS?hl=en-US&gl=US&ceid=US:en",
    "Google News (Tech)": "https://news.google.com/rss/headlines/section/topic/TECHNOLOGY?hl=en-US&gl=US&ceid=US:en",
    "Google News (KR Biz)": "https://news.google.com/rss/headlines/section/topic/BUSINESS?hl=ko&gl=KR&ceid=KR:ko",
    "Google News (KR Tech)": "https://news.google.com/rss/headlines/section/topic/TECHNOLOGY?hl=ko&gl=KR&ceid=KR:ko",
    "Hacker News": "https://news.ycombinator.com/rss",
    "TechCrunch": "https://techcrunch.com/feed/",
    "Project Syndicate": "https://www.project-syndicate.org/rss",
    "OilPrice": "https://oilprice.com/rss/main",
    "CoinDesk": "https://www.coindesk.com/arc/outboundfeeds/rss/",
}

def fetch_news() -> list[dict]:
    print("\n[PHASE 1] RSS ìˆ˜ì§‘ ì‹œì‘...")
    all_news = []
    for source, url in RSS_URLS.items():
        try:
            feed = feedparser.parse(url)
            count = 0
            for entry in feed.entries[:15]:
                title = clean_rss_text(getattr(entry, "title", ""))
                link = clean_rss_text(getattr(entry, "link", ""))
                pub_date = clean_rss_text(getattr(entry, "published", ""))
                content = ""
                if hasattr(entry, "content"):
                    content = entry.content[0].value
                elif hasattr(entry, "summary_detail"):
                    content = entry.summary_detail.value
                elif hasattr(entry, "summary"):
                    content = entry.summary
                content = clean_rss_text(content)[:3000]

                if title:
                    all_news.append({
                        "source": source,
                        "title": title,
                        "content": content,
                        "date": pub_date,
                        "link": link,
                    })
                    count += 1
            print(f"  [{source}] {count}ê±´ ìˆ˜ì§‘")
        except Exception as e:
            print(f"  [{source}] ìˆ˜ì§‘ ì‹¤íŒ¨: {e}")
    print(f"  ì´ {len(all_news)}ê±´ ìˆ˜ì§‘ ì™„ë£Œ")
    return all_news

# ============================================================
# [3] Tier-1: Haiku í•„í„°ë§ (ìƒìœ„ 5% ì„ ë³„)
# ============================================================

def tier1_filter(news_list: list[dict], client: anthropic.Anthropic) -> list[dict]:
    """
    Haiku 3.5ë¡œ ê° ë‰´ìŠ¤ì˜ íˆ¬ì ì¤‘ìš”ë„ë¥¼ 0-100 ìŠ¤ì½”ì–´ë§.
    ë°°ì¹˜ ì²˜ë¦¬ë¡œ API í˜¸ì¶œ ìµœì†Œí™”.
    ìƒìœ„ 5%ë§Œ ë°˜í™˜.
    """
    print(f"\n[PHASE 2] Tier-1 í•„í„°ë§ (Haiku) â€” {len(news_list)}ê±´ ìŠ¤ì½”ì–´ë§...")

    if not news_list:
        return []

    # ë°°ì¹˜ ë‹¨ìœ„ë¡œ ë‰´ìŠ¤ë¥¼ ë¬¶ì–´ì„œ í•œ ë²ˆì— ìŠ¤ì½”ì–´ë§ (10ê±´ì”©)
    BATCH_SIZE = 20
    scored_news = []

    for batch_start in range(0, len(news_list), BATCH_SIZE):
        batch = news_list[batch_start:batch_start + BATCH_SIZE]
        batch_text = ""
        for i, item in enumerate(batch):
            batch_text += f"[{i}] {item['source']} | {item['title']} | {item['content'][:500]}\n"

        scoring_prompt = f"""ë‹¹ì‹ ì€ ê¸€ë¡œë²Œ íˆ¬ì ì „ëµê°€ì…ë‹ˆë‹¤. ì•„ë˜ ë‰´ìŠ¤ ê°ê°ì— ëŒ€í•´ íˆ¬ì ì˜ì‚¬ê²°ì • ì¤‘ìš”ë„ë¥¼ 0-100ìœ¼ë¡œ í‰ê°€í•˜ì„¸ìš”.

í‰ê°€ ê¸°ì¤€:
- ì‹œì¥ ì „ì²´ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ë ¥ (ê±°ì‹œê²½ì œ, ê¸ˆë¦¬, ì§€ì •í•™)
- íŠ¹ì • ì„¹í„°/ìì‚°êµ°ì— ëŒ€í•œ ì§ì ‘ì  ì˜í–¥
- ì •ë³´ì˜ ì‹ ê·œì„± (ì´ë¯¸ ì•Œë ¤ì§„ ë‚´ìš© vs ìƒˆë¡œìš´ ì‹œê·¸ë„)
- ì‹¤í–‰ ê°€ëŠ¥ì„± (êµ¬ì²´ì  íˆ¬ì í–‰ë™ìœ¼ë¡œ ì—°ê²° ê°€ëŠ¥ ì—¬ë¶€)

ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´ JSONë§Œ ì¶œë ¥:
{{"scores": [{{"id": 0, "score": 85, "reason": "í•œì¤„ì´ìœ "}}, ...]}}

ë‰´ìŠ¤ ëª©ë¡:
{batch_text}"""

        try:
            response = client.messages.create(
                model="claude-haiku-4-5-20241022",
                max_tokens=2000,
                messages=[{"role": "user", "content": scoring_prompt}],
            )
            response_text = response.content[0].text.strip()

            # JSON íŒŒì‹± (ì½”ë“œë¸”ë¡ ì œê±°)
            json_match = re.search(r"\{.*\}", response_text, re.DOTALL)
            if json_match:
                result = json.loads(json_match.group())
                for item in result.get("scores", []):
                    idx = item["id"]
                    if 0 <= idx < len(batch):
                        batch[idx]["score"] = item.get("score", 0)
                        batch[idx]["filter_reason"] = item.get("reason", "")
                        scored_news.append(batch[idx])
            else:
                print(f"    ë°°ì¹˜ {batch_start} JSON íŒŒì‹± ì‹¤íŒ¨, ì „ì²´ í¬í•¨ ì²˜ë¦¬")
                for item in batch:
                    item["score"] = 50
                    scored_news.append(item)

        except Exception as e:
            print(f"    ë°°ì¹˜ {batch_start} Haiku í˜¸ì¶œ ì‹¤íŒ¨: {e}")
            for item in batch:
                item["score"] = 50
                scored_news.append(item)

    # ìŠ¤ì½”ì–´ ê¸°ì¤€ ì •ë ¬ í›„ ìƒìœ„ 5% ì„ ë³„ (ìµœì†Œ 3ê±´)
    scored_news.sort(key=lambda x: x.get("score", 0), reverse=True)
    top_count = max(3, int(len(scored_news) * 0.05))
    top_news = scored_news[:top_count]

    print(f"  ìŠ¤ì½”ì–´ë§ ì™„ë£Œ. ìƒìœ„ {top_count}ê±´ ì„ ë³„:")
    for item in top_news:
        print(f"    [{item.get('score', '?')}ì ] {item['source']} â€” {item['title'][:60]}")

    return top_news

# ============================================================
# [4] Tier-2: Sonnet ì •ë°€ ë¶„ì„ (ë¦¬í¬íŠ¸ ìƒì„±)
# ============================================================

REPORT_PROMPTS = {
    "daily": """
# ğŸŒŒ STRATEGIC COUNCIL: ì¼ê°„ ë¸Œë¦¬í•‘

**ì—­í• :** ë‹¹ì‹ ì€ 'Chief Architect'ì…ë‹ˆë‹¤.
**ëª©í‘œ:** ì˜¤ëŠ˜ì˜ í•µì‹¬ ì‹œì¥ ì‹œê·¸ë„ì„ ì •ë°€ ë¶„ì„í•œ HTML ì´ë©”ì¼ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
**ì–¸ì–´:** í•œêµ­ì–´

**ğŸ¨ ë””ìì¸ ì§€ì‹œ (HTML & Inline CSS):**
* ëª¨ë˜í•˜ê³  ê¹”ë”í•œ ë””ìì¸ ì‚¬ìš©
* **Dr. Doom (ë¦¬ìŠ¤í¬):** <span style='color: #D32F2F; font-weight:bold;'>ë¹¨ê°„ìƒ‰</span>
* **The Visionary (ì„±ì¥):** <span style='color: #1976D2; font-weight:bold;'>íŒŒë€ìƒ‰</span>
* **The Hawk (ë§¤í¬ë¡œ):** <span style='color: #388E3C; font-weight:bold;'>ì´ˆë¡ìƒ‰</span>
* **The Fox (ì—­ë°œìƒ):** <span style='color: #FBC02D; font-weight:bold; background-color: #333; padding: 2px;'>ë…¸ë€ìƒ‰</span>
* `<h3>` ì±•í„° ì œëª©, `<ul><li>` ë¦¬ìŠ¤íŠ¸, `<b>` ê°•ì¡°, Markdown ê¸ˆì§€

## ğŸ“ ë¦¬í¬íŠ¸ êµ¬ì¡°

<h3>ğŸ‘‘ CHAPTER 1. Architect's Daily Verdict</h3>
<div style="border:1px solid #ccc; padding:15px; background:#f9f9f9; border-radius:5px;">
  <p><b>ì˜¤ëŠ˜ì˜ ì „ëµ ë²¡í„°:</b> (ê°€ì¥ ì¤‘ìš”í•œ ë‹¨ì¼ íŠ¸ë Œë“œ)</p>
  <p><b>ì‹œì¥ ìŠ¤íƒ ìŠ¤:</b> [ê³µê²©ì  ë§¤ìˆ˜ / ì‹ ì¤‘ ë§¤ìˆ˜ / ì¤‘ë¦½ / ë§¤ë„ / ìˆ]</p>
  <p><b>í™•ì‹ ë„:</b> [0-100%]</p>
  <p><b>í•µì‹¬ ìš”ì•½:</b> (3ë¬¸ì¥ ì´ë‚´)</p>
</div>

<h3>ğŸ—£ï¸ CHAPTER 2. Council Debate</h3>
<p><i>4ì¸ ìœ„ì›íšŒì˜ ì§§ê³  ê²©ë ¬í•œ í† ë¡ ì„ ì‹œë®¬ë ˆì´ì…˜í•˜ì„¸ìš”.</i></p>

<h3>ğŸ‘ï¸ CHAPTER 3. ê·¼ê±° ì‚¼ê°ì¸¡ëŸ‰</h3>
<ul>
  <li><b>[ë§¤í¬ë¡œ/ì—ë„ˆì§€]:</b> ...</li>
  <li><b>[í…Œí¬/VC]:</b> ...</li>
  <li><b>[ì‹œì¥/ìê¸ˆíë¦„]:</b> ...</li>
  <li><b>[ì§€ì •í•™/ê°ˆë“±]:</b> ...</li>
</ul>

<h3>âš”ï¸ CHAPTER 4. ì˜¤ëŠ˜ì˜ ì•¡ì…˜ í”Œëœ</h3>
<table border="1" cellpadding="10" cellspacing="0" style="border-collapse:collapse; width:100%;">
  <tr style="background:#eee;"><th>êµ¬ë¶„</th><th>í–‰ë™</th></tr>
  <tr><td><b>ğŸ›¡ï¸ ë°©ì–´</b></td><td>(ì†ì‹¤ ë°©ì§€ ì „ëµ)</td></tr>
  <tr><td><b>âš”ï¸ ê³µê²©</b></td><td>(ìˆ˜ìµ ê¸°íšŒ)</td></tr>
  <tr><td><b>ğŸš¨ í‚¬ ìŠ¤ìœ„ì¹˜</b></td><td>(ì¦‰ì‹œ ì²­ì‚° ì¡°ê±´)</td></tr>
</table>

<h3>ğŸ“Š CHAPTER 5. í¬íŠ¸í´ë¦¬ì˜¤ ì‹œì‚¬ì </h3>
<p>ì˜¤ëŠ˜ì˜ ë‰´ìŠ¤ê°€ ê¸°ì¡´ í¬íŠ¸í´ë¦¬ì˜¤ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ê³¼ ë¦¬ë°¸ëŸ°ì‹± í•„ìš” ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ì„¸ìš”.</p>
<ul>
  <li><b>ì£¼ì‹ ë¹„ì¤‘ ì¡°ì •:</b> ...</li>
  <li><b>ì±„ê¶Œ/í˜„ê¸ˆ ë¹„ì¤‘:</b> ...</li>
  <li><b>ì„¹í„° ë¡œí…Œì´ì…˜:</b> ...</li>
  <li><b>í—¤ì§€ í•„ìš” ì—¬ë¶€:</b> ...</li>
</ul>
""",

    "weekly": """
# ğŸ“Š STRATEGIC COUNCIL: ì£¼ê°„ ì „ëµ ë¦¬í¬íŠ¸

**ì—­í• :** Chief Architect
**ëª©í‘œ:** ì´ë²ˆ ì£¼ ì‹œì¥ ë™í–¥ì„ ì¢…í•©í•˜ê³ , ë‹¤ìŒ ì£¼ ì „ëµì„ ìˆ˜ë¦½í•˜ëŠ” HTML ì´ë©”ì¼ ë¦¬í¬íŠ¸
**ì–¸ì–´:** í•œêµ­ì–´

**ë””ìì¸:** ì¼ê°„ ë¦¬í¬íŠ¸ì™€ ë™ì¼í•œ ìƒ‰ìƒ ì²´ê³„ ì ìš©

## ğŸ“ ë¦¬í¬íŠ¸ êµ¬ì¡°

<h3>ğŸ‘‘ CHAPTER 1. ì£¼ê°„ ì „ëµ íŒì •</h3>
<div style="border:1px solid #ccc; padding:15px; background:#f9f9f9; border-radius:5px;">
  <p><b>ê¸ˆì£¼ í•µì‹¬ í…Œë§ˆ:</b> (3ê°œ ì´ë‚´)</p>
  <p><b>ì‹œì¥ ìŠ¤íƒ ìŠ¤ ë³€í™”:</b> [ì§€ë‚œì£¼ ëŒ€ë¹„ ë³€í™” ë°©í–¥]</p>
  <p><b>í™•ì‹ ë„:</b> [0-100%]</p>
  <p><b>ë‹¤ìŒ ì£¼ ì „ë§:</b> (í•µì‹¬ ì‹œë‚˜ë¦¬ì˜¤)</p>
</div>

<h3>ğŸ—£ï¸ CHAPTER 2. ì£¼ê°„ Council Debate</h3>
<p>ì´ë²ˆ ì£¼ ê°€ì¥ ë…¼ìŸì ì´ì—ˆë˜ ì´ìŠˆì— ëŒ€í•œ 4ì¸ í† ë¡ </p>

<h3>ğŸ“ˆ CHAPTER 3. ì£¼ê°„ ì‹œì¥ ìŠ¤ì½”ì–´ì¹´ë“œ</h3>
<table border="1" cellpadding="8" cellspacing="0" style="border-collapse:collapse; width:100%;">
  <tr style="background:#eee;"><th>ìì‚°êµ°</th><th>ì£¼ê°„ ë™í–¥</th><th>ì‹œê·¸ë„</th><th>ë‹¤ìŒ ì£¼ ì „ë§</th></tr>
  <tr><td>ë¯¸êµ­ ì£¼ì‹</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>í•œêµ­ ì£¼ì‹</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ì±„ê¶Œ</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ì›ìì¬/ì—ë„ˆì§€</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>í¬ë¦½í† </td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>í™˜ìœ¨(USD/KRW)</td><td>...</td><td>...</td><td>...</td></tr>
</table>

<h3>âš”ï¸ CHAPTER 4. ì£¼ê°„ í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬ë°¸ëŸ°ì‹± ê¶Œê³ </h3>
<table border="1" cellpadding="10" cellspacing="0" style="border-collapse:collapse; width:100%;">
  <tr style="background:#eee;"><th>ìì‚°êµ°</th><th>í˜„ì¬ ê¶Œì¥ ë¹„ì¤‘</th><th>ì¡°ì • ë°©í–¥</th><th>ê·¼ê±°</th></tr>
  <tr><td>ì„±ì¥ì£¼</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ê°€ì¹˜ì£¼</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ì±„ê¶Œ</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>í˜„ê¸ˆ</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ëŒ€ì•ˆíˆ¬ì</td><td>...</td><td>...</td><td>...</td></tr>
</table>

<h3>ğŸ“š CHAPTER 5. ë‹¤ìŒ ì£¼ í•µì‹¬ ì´ë²¤íŠ¸ ìº˜ë¦°ë”</h3>
<ul>
  <li><b>ì›”:</b> ...</li>
  <li><b>í™”:</b> ...</li>
  <li><b>ìˆ˜:</b> ...</li>
  <li><b>ëª©:</b> ...</li>
  <li><b>ê¸ˆ:</b> ...</li>
</ul>
""",

    "monthly": """
# ğŸ“… STRATEGIC COUNCIL: ì›”ê°„ ì „ëµ ë¦¬í¬íŠ¸

**ì—­í• :** Chief Architect
**ëª©í‘œ:** ì´ë²ˆ ë‹¬ ì‹œì¥ì„ ì¢…í•© í‰ê°€í•˜ê³ , ë‹¤ìŒ ë‹¬ ì „ëµ ë° í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™” ë°©ì•ˆì„ ì œì‹œí•˜ëŠ” HTML ì´ë©”ì¼ ë¦¬í¬íŠ¸
**ì–¸ì–´:** í•œêµ­ì–´

## ğŸ“ ë¦¬í¬íŠ¸ êµ¬ì¡°

<h3>ğŸ‘‘ CHAPTER 1. ì›”ê°„ ì „ëµ íŒì •</h3>
<div style="border:1px solid #ccc; padding:15px; background:#f9f9f9; border-radius:5px;">
  <p><b>ì´ë‹¬ì˜ ë§¤í¬ë¡œ ë‚´ëŸ¬í‹°ë¸Œ:</b> ...</p>
  <p><b>ì‹œì¥ ë ˆì§:</b> [Risk-On / Risk-Off / Transition]</p>
  <p><b>ì›”ê°„ ì„±ê³¼ í‰ê°€:</b> ...</p>
  <p><b>ë‹¤ìŒ ë‹¬ í•µì‹¬ ì‹œë‚˜ë¦¬ì˜¤:</b> ...</p>
</div>

<h3>ğŸ—£ï¸ CHAPTER 2. ì›”ê°„ ì‹¬ì¸µ í† ë¡ </h3>
<p>ì´ë‹¬ ê°€ì¥ ì¤‘ìš”í•œ êµ¬ì¡°ì  ë³€í™”ì— ëŒ€í•œ 4ì¸ ìœ„ì›íšŒ ì‹¬ì¸µ ë¶„ì„</p>

<h3>ğŸ“Š CHAPTER 3. ì›”ê°„ ìì‚°êµ° ì„±ê³¼ ë¶„ì„</h3>
<table border="1" cellpadding="8" cellspacing="0" style="border-collapse:collapse; width:100%;">
  <tr style="background:#eee;"><th>ìì‚°êµ°</th><th>ì›”ê°„ ìˆ˜ìµë¥ </th><th>í•µì‹¬ ë“œë¼ì´ë²„</th><th>ë‹¤ìŒ ë‹¬ ì „ë§</th></tr>
</table>

<h3>ğŸ—ï¸ CHAPTER 4. ìµœì  í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±ì•ˆ</h3>
<p><b>ëª©í‘œ:</b> ë¦¬ìŠ¤í¬ ëŒ€ë¹„ ìˆ˜ìµë¥  ìµœì í™” (Sharpe Ratio ê·¹ëŒ€í™”)</p>
<table border="1" cellpadding="10" cellspacing="0" style="border-collapse:collapse; width:100%;">
  <tr style="background:#eee;"><th>ìì‚°êµ°</th><th>ê¶Œì¥ ë¹„ì¤‘(%)</th><th>ì „ì›” ëŒ€ë¹„ ë³€í™”</th><th>ê·¼ê±°</th></tr>
  <tr><td>ë¯¸êµ­ ëŒ€í˜• ì„±ì¥ì£¼</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ë¯¸êµ­ ëŒ€í˜• ê°€ì¹˜ì£¼</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>í•œêµ­ ì£¼ì‹</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ì„ ì§„êµ­ ì£¼ì‹(ex-US)</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ì´ë¨¸ì§• ì£¼ì‹</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ë¯¸êµ­ êµ­ì±„(ì¥ê¸°)</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>íšŒì‚¬ì±„/í•˜ì´ì¼ë“œ</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ì›ìì¬/ê¸ˆ</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>í¬ë¦½í† </td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>í˜„ê¸ˆ</td><td>...</td><td>...</td><td>...</td></tr>
</table>

<h3>ğŸ”„ CHAPTER 5. ë¦¬ë°¸ëŸ°ì‹± ì‹¤í–‰ ê³„íš</h3>
<ul>
  <li><b>ì¦‰ì‹œ ì‹¤í–‰:</b> ...</li>
  <li><b>ì¡°ê±´ë¶€ ì‹¤í–‰:</b> (íŠ¹ì • ê°€ê²©/ì´ë²¤íŠ¸ ë„ë‹¬ ì‹œ)</li>
  <li><b>ê´€ë§:</b> ...</li>
</ul>

<h3>ğŸ“š CHAPTER 6. ë¦¬í¬íŠ¸ í•´ì„ ê°€ì´ë“œ</h3>
<div style="border:1px solid #1976D2; padding:15px; background:#E3F2FD; border-radius:5px;">
  <p><b>ì´ ë¦¬í¬íŠ¸ë¥¼ ì½ëŠ” ë²•:</b></p>
  <ul>
    <li>ì‹œì¥ ë ˆì§ì´ 'Risk-On'ì´ë©´ ì£¼ì‹ ë¹„ì¤‘ í™•ëŒ€, 'Risk-Off'ë©´ ì±„ê¶Œ/í˜„ê¸ˆ í™•ëŒ€</li>
    <li>í™•ì‹ ë„ 70% ì´ìƒì¼ ë•Œë§Œ ì ê·¹ì  í¬ì§€ì…˜ ë³€ê²½ ê¶Œì¥</li>
    <li>í‚¬ ìŠ¤ìœ„ì¹˜ ì¡°ê±´ ì¶©ì¡± ì‹œ ëª¨ë“  ë¦¬ìŠ¤í¬ ìì‚° ë¹„ì¤‘ 50% ì¶•ì†Œ</li>
    <li>ë¦¬ë°¸ëŸ°ì‹±ì€ ì›” 1íšŒ ì •ê¸° + í‚¬ ìŠ¤ìœ„ì¹˜ ë°œë™ ì‹œ ë¹„ì •ê¸° ì‹¤í–‰</li>
  </ul>
</div>
""",

    "quarterly": """
# ğŸ“Š STRATEGIC COUNCIL: ë¶„ê¸° ì „ëµ ë¦¬í¬íŠ¸

**ì—­í• :** Chief Architect
**ëª©í‘œ:** ë¶„ê¸° ë‹¨ìœ„ ê±°ì‹œê²½ì œ ì‚¬ì´í´ ë¶„ì„, ì„¹í„° ë¡œí…Œì´ì…˜ ì „ëµ, í¬íŠ¸í´ë¦¬ì˜¤ ëŒ€ê·œëª¨ ë¦¬ë°¸ëŸ°ì‹± ê¶Œê³ 
**ì–¸ì–´:** í•œêµ­ì–´

## ğŸ“ ë¦¬í¬íŠ¸ êµ¬ì¡°

<h3>ğŸ‘‘ CHAPTER 1. ë¶„ê¸° ê±°ì‹œê²½ì œ íŒì •</h3>
<div style="border:1px solid #ccc; padding:15px; background:#f9f9f9; border-radius:5px;">
  <p><b>ê²½ê¸° ì‚¬ì´í´ ìœ„ì¹˜:</b> [ì´ˆê¸° í™•ì¥ / ì¤‘ê¸° í™•ì¥ / í›„ê¸° í™•ì¥ / ìˆ˜ì¶•]</p>
  <p><b>ê¸ˆë¦¬ ì‚¬ì´í´:</b> [ì¸ìƒê¸° / ë™ê²°ê¸° / ì¸í•˜ê¸°]</p>
  <p><b>ìœ ë™ì„± í™˜ê²½:</b> [ê¸´ì¶• / ì¤‘ë¦½ / ì™„í™”]</p>
  <p><b>ë¶„ê¸° í•µì‹¬ í…Œë§ˆ 3ê°€ì§€:</b> ...</p>
</div>

<h3>ğŸ—£ï¸ CHAPTER 2. ë¶„ê¸° ì „ëµ ëŒ€í† ë¡ </h3>
<p>í–¥í›„ 3ê°œì›” ì‹œì¥ ë°©í–¥ì„±ì— ëŒ€í•œ 4ì¸ ìœ„ì›íšŒ ì‹¬ì¸µ í† ë¡ </p>

<h3>ğŸ”„ CHAPTER 3. ì„¹í„° ë¡œí…Œì´ì…˜ ë§¤íŠ¸ë¦­ìŠ¤</h3>
<table border="1" cellpadding="8" cellspacing="0" style="border-collapse:collapse; width:100%;">
  <tr style="background:#eee;"><th>ì„¹í„°</th><th>í˜„ì¬ ì‚¬ì´í´ ì í•©ë„</th><th>ë¹„ì¤‘ ê¶Œê³ </th><th>í•µì‹¬ ì¢…ëª©/ETF</th></tr>
  <tr><td>í…Œí¬/AI</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>í—¬ìŠ¤ì¼€ì–´</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ê¸ˆìœµ</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ì—ë„ˆì§€</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ì†Œë¹„ì¬</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ì‚°ì—…ì¬</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ìœ í‹¸ë¦¬í‹°</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ë¶€ë™ì‚°(REITs)</td><td>...</td><td>...</td><td>...</td></tr>
</table>

<h3>ğŸ—ï¸ CHAPTER 4. ë¶„ê¸° ìµœì  í¬íŠ¸í´ë¦¬ì˜¤</h3>
<p>ì „ë¶„ê¸° ëŒ€ë¹„ ëŒ€ê·œëª¨ ì¡°ì • ì‚¬í•­ í¬í•¨</p>

<h3>âš ï¸ CHAPTER 5. ë¶„ê¸° ë¦¬ìŠ¤í¬ ë§¤íŠ¸ë¦­ìŠ¤</h3>
<table border="1" cellpadding="8" cellspacing="0" style="border-collapse:collapse; width:100%;">
  <tr style="background:#eee;"><th>ë¦¬ìŠ¤í¬</th><th>ë°œìƒ í™•ë¥ </th><th>ì˜í–¥ë„</th><th>í—¤ì§€ ì „ëµ</th></tr>
</table>

<h3>ğŸ“š CHAPTER 6. íˆ¬ì êµìœ¡: ë¦¬ë°¸ëŸ°ì‹± ìµœì  ì „ëµ</h3>
<div style="border:1px solid #388E3C; padding:15px; background:#E8F5E9; border-radius:5px;">
  <p><b>ë¦¬ë°¸ëŸ°ì‹± ì›ì¹™:</b></p>
  <ul>
    <li><b>ì‹œê°„ ê¸°ë°˜:</b> ë¶„ê¸° 1íšŒ ì •ê¸° ë¦¬ë°¸ëŸ°ì‹± (ê±°ë˜ë¹„ìš© ìµœì†Œí™”)</li>
    <li><b>ë°´ë“œ ê¸°ë°˜:</b> ëª©í‘œ ë¹„ì¤‘ ëŒ€ë¹„ Â±5%p ì´íƒˆ ì‹œ ë¹„ì •ê¸° ë¦¬ë°¸ëŸ°ì‹±</li>
    <li><b>ì„¸ê¸ˆ íš¨ìœ¨:</b> ì†ì‹¤ ìì‚° ë¨¼ì € ë§¤ë„ (Tax-Loss Harvesting)</li>
    <li><b>ì‹¤í–‰ ìˆœì„œ:</b> í˜„ê¸ˆ ìœ ì…ë¶„ â†’ ì €ë¹„ì¤‘ ìì‚° ë§¤ìˆ˜ â†’ ê³ ë¹„ì¤‘ ìì‚° ë§¤ë„</li>
  </ul>
</div>
""",

    "semi_annual": """
# ğŸ“Š STRATEGIC COUNCIL: ë°˜ê¸° ì „ëµ ë¦¬í¬íŠ¸

**ì—­í• :** Chief Architect
**ëª©í‘œ:** ë°˜ê¸° ë‹¨ìœ„ í¬íŠ¸í´ë¦¬ì˜¤ ì„±ê³¼ í‰ê°€, ì „ëµ ìì‚°ë°°ë¶„(SAA) ê²€í† , ì¥ê¸° í…Œë§ˆ ì—…ë°ì´íŠ¸
**ì–¸ì–´:** í•œêµ­ì–´

## ğŸ“ ë¦¬í¬íŠ¸ êµ¬ì¡°

<h3>ğŸ‘‘ CHAPTER 1. ë°˜ê¸° ì„±ê³¼ í‰ê°€</h3>
<div style="border:1px solid #ccc; padding:15px; background:#f9f9f9; border-radius:5px;">
  <p><b>ë°˜ê¸° í¬íŠ¸í´ë¦¬ì˜¤ ì¶”ì • ìˆ˜ìµë¥ :</b> ...</p>
  <p><b>ë²¤ì¹˜ë§ˆí¬ ëŒ€ë¹„:</b> [ì´ˆê³¼ / ë¯¸ë‹¬ / ë¶€í•©]</p>
  <p><b>ìµœëŒ€ ê¸°ì—¬ ìì‚°:</b> ...</p>
  <p><b>ìµœëŒ€ ì†ì‹¤ ìì‚°:</b> ...</p>
  <p><b>ì „ëµ ìœ íš¨ì„± í‰ê°€:</b> ...</p>
</div>

<h3>ğŸŒ CHAPTER 2. ê¸€ë¡œë²Œ ë§¤í¬ë¡œ ë°˜ê¸° ë¦¬ë·°</h3>
<p>ì£¼ìš”êµ­ ê²½ì œ ì„±ì¥ë¥ , ì¸í”Œë ˆì´ì…˜, ê¸ˆë¦¬ ì •ì±… ì¢…í•© ë¶„ì„</p>

<h3>ğŸ”® CHAPTER 3. í–¥í›„ 6ê°œì›” ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„</h3>
<table border="1" cellpadding="8" cellspacing="0" style="border-collapse:collapse; width:100%;">
  <tr style="background:#eee;"><th>ì‹œë‚˜ë¦¬ì˜¤</th><th>í™•ë¥ </th><th>ì„¤ëª…</th><th>í¬íŠ¸í´ë¦¬ì˜¤ ëŒ€ì‘</th></tr>
  <tr><td>ğŸŸ¢ ë‚™ê´€</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ğŸŸ¡ ê¸°ë³¸</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>ğŸ”´ ë¹„ê´€</td><td>...</td><td>...</td><td>...</td></tr>
  <tr><td>âš« ë¸”ë™ìŠ¤ì™„</td><td>...</td><td>...</td><td>...</td></tr>
</table>

<h3>ğŸ—ï¸ CHAPTER 4. ì „ëµ ìì‚°ë°°ë¶„(SAA) ì¬ê²€í† </h3>
<p>ì¥ê¸° ëª©í‘œ ë¹„ì¤‘ ì¡°ì • ì—¬ë¶€ íŒë‹¨</p>

<h3>ğŸ“š CHAPTER 5. íˆ¬ì êµìœ¡: í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì¶• ì›ì¹™</h3>
<div style="border:1px solid #1976D2; padding:15px; background:#E3F2FD; border-radius:5px;">
  <ul>
    <li><b>ì½”ì–´-ìƒˆí‹€ë¼ì´íŠ¸:</b> í•µì‹¬ ìì‚°(70-80%) + ì „ìˆ ì  ìì‚°(20-30%)</li>
    <li><b>ìƒê´€ê´€ê³„:</b> ìì‚° ê°„ ìƒê´€ê³„ìˆ˜ 0.5 ì´í•˜ ìœ ì§€ ëª©í‘œ</li>
    <li><b>ë¦¬ìŠ¤í¬ ë²„ì§“:</b> ì „ì²´ í¬íŠ¸í´ë¦¬ì˜¤ ë³€ë™ì„± ëª©í‘œ ì„¤ì •</li>
    <li><b>ìœ ë™ì„± ê³„ì¸µ:</b> ì¦‰ì‹œ í˜„ê¸ˆí™” ê°€ëŠ¥ ìì‚° ìµœì†Œ 20% ìœ ì§€</li>
  </ul>
</div>
""",

    "annual": """
# ğŸ“Š STRATEGIC COUNCIL: ì—°ê°„ ì „ëµ ë¦¬í¬íŠ¸

**ì—­í• :** Chief Architect
**ëª©í‘œ:** ì—°ê°„ ì¢…í•© ì„±ê³¼ í‰ê°€, ì¥ê¸° íˆ¬ì ì² í•™ ì ê²€, ì°¨ë…„ë„ ì „ëµ ìì‚°ë°°ë¶„ ìˆ˜ë¦½
**ì–¸ì–´:** í•œêµ­ì–´

## ğŸ“ ë¦¬í¬íŠ¸ êµ¬ì¡°

<h3>ğŸ‘‘ CHAPTER 1. ì—°ê°„ ì¢…í•© íŒì •</h3>
<div style="border:1px solid #ccc; padding:15px; background:#f9f9f9; border-radius:5px;">
  <p><b>ì˜¬í•´ì˜ ì‹œì¥ í•œ ì¤„ ìš”ì•½:</b> ...</p>
  <p><b>ì—°ê°„ í¬íŠ¸í´ë¦¬ì˜¤ ì¶”ì • ìˆ˜ìµë¥ :</b> ...</p>
  <p><b>ì „ëµ ì ì¤‘ë¥ :</b> ...</p>
  <p><b>ìµœëŒ€ êµí›ˆ:</b> ...</p>
</div>

<h3>ğŸ“Š CHAPTER 2. ì—°ê°„ ìì‚°êµ° ì„±ê³¼ ì´ì •ë¦¬</h3>
<table border="1" cellpadding="8" cellspacing="0" style="border-collapse:collapse; width:100%;">
  <tr style="background:#eee;"><th>ìì‚°êµ°</th><th>ì—°ê°„ ìˆ˜ìµë¥ </th><th>ë³€ë™ì„±</th><th>Sharpe</th><th>ë¹„ê³ </th></tr>
</table>

<h3>ğŸ”® CHAPTER 3. ì°¨ë…„ë„ ë§¤í¬ë¡œ ì „ë§</h3>
<p>4ì¸ ìœ„ì›íšŒì˜ ì°¨ë…„ë„ ì‹œì¥ ì „ë§ ì‹¬ì¸µ í† ë¡ </p>

<h3>ğŸ—ï¸ CHAPTER 4. ì°¨ë…„ë„ ì „ëµ ìì‚°ë°°ë¶„(SAA)</h3>
<table border="1" cellpadding="10" cellspacing="0" style="border-collapse:collapse; width:100%;">
  <tr style="background:#eee;"><th>ìì‚°êµ°</th><th>ê¸ˆë…„ ë¹„ì¤‘</th><th>ì°¨ë…„ ëª©í‘œ ë¹„ì¤‘</th><th>ë³€í™”</th><th>ê·¼ê±°</th></tr>
</table>

<h3>ğŸ”„ CHAPTER 5. ì°¨ë…„ë„ ë¦¬ë°¸ëŸ°ì‹± ìº˜ë¦°ë”</h3>
<ul>
  <li><b>1ì›”:</b> ì—°ì´ˆ ì „ëµ ë°°ë¶„ ì‹¤í–‰</li>
  <li><b>4ì›”:</b> Q1 ë¦¬ë·° + ë¶„ê¸° ë¦¬ë°¸ëŸ°ì‹±</li>
  <li><b>7ì›”:</b> ë°˜ê¸° ë¦¬ë·° + SAA ì¬ê²€í† </li>
  <li><b>10ì›”:</b> Q3 ë¦¬ë·° + ì—°ë§ ì„¸ê¸ˆ ì „ëµ</li>
  <li><b>12ì›”:</b> Tax-Loss Harvesting + ì°¨ë…„ë„ ì¤€ë¹„</li>
</ul>

<h3>ğŸ“š CHAPTER 6. ì—°ê°„ íˆ¬ì êµìœ¡ ì´ì •ë¦¬</h3>
<div style="border:1px solid #D32F2F; padding:15px; background:#FFEBEE; border-radius:5px;">
  <p><b>ì˜¬í•´ ë°°ìš´ í•µì‹¬ êµí›ˆ:</b></p>
  <ul>
    <li><b>í–‰ë™ í¸í–¥:</b> ì˜¬í•´ ê°€ì¥ ë§ì´ ë²”í•œ ì¸ì§€ í¸í–¥ê³¼ êµì • ë°©ë²•</li>
    <li><b>ë¦¬ìŠ¤í¬ ê´€ë¦¬:</b> í‚¬ ìŠ¤ìœ„ì¹˜ ë°œë™ ì‚¬ë¡€ì™€ íš¨ê³¼ í‰ê°€</li>
    <li><b>ë³µë¦¬ì˜ í˜:</b> ì¥ê¸° íˆ¬ì ê´€ì ì—ì„œì˜ ì˜¬í•´ í¬ì§€ì…”ë‹ í‰ê°€</li>
  </ul>
</div>
""",
}

def tier2_analyze(top_news: list[dict], report_type: str, client: anthropic.Anthropic, accumulated_context: str = "") -> str:
    """
    Sonnet 3.5ë¡œ ì„ ë³„ëœ ë‰´ìŠ¤ë¥¼ ì •ë°€ ë¶„ì„í•˜ì—¬ ë¦¬í¬íŠ¸ ìƒì„±.
    """
    print(f"\n[PHASE 3] Tier-2 ë¶„ì„ (Sonnet) â€” {report_type} ë¦¬í¬íŠ¸ ìƒì„±...")

    news_text = ""
    for item in top_news:
        news_text += f"[{item['source']}] (Score: {item.get('score', 'N/A')}) {item['title']}\n"
        news_text += f"  Content: {item['content'][:1500]}\n"
        news_text += f"  Date: {item['date']} | Link: {item['link']}\n\n"

    base_prompt = REPORT_PROMPTS.get(report_type, REPORT_PROMPTS["daily"])

    context_section = ""
    if accumulated_context:
        context_section = f"""
**[ëˆ„ì  ì»¨í…ìŠ¤íŠ¸ â€” ì´ì „ ë¦¬í¬íŠ¸ ìš”ì•½]**
{accumulated_context}
"""

    full_prompt = f"""{base_prompt}

{context_section}

---
**[Tier-1 í•„í„°ë§ í†µê³¼ í•µì‹¬ ë‰´ìŠ¤ ë°ì´í„°]**
{news_text}
"""

    try:
        response = client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=8000,
            messages=[{"role": "user", "content": full_prompt}],
        )
        return clean_report_body(response.content[0].text)
    except Exception as e:
        return f"<h3>ë¶„ì„ ì˜¤ë¥˜</h3><p>{e}</p><pre>{traceback.format_exc()}</pre>"

# ============================================================
# [5] ì´ë©”ì¼ ë°œì†¡
# ============================================================

def send_email(report_body: str, report_type: str):
    print(f"\n[PHASE 4] ì´ë©”ì¼ ë°œì†¡ ({report_type})...")

    type_labels = {
        "daily": "ì¼ê°„ ë¸Œë¦¬í•‘",
        "weekly": "ì£¼ê°„ ì „ëµ",
        "monthly": "ì›”ê°„ ì „ëµ",
        "quarterly": "ë¶„ê¸° ì „ëµ",
        "semi_annual": "ë°˜ê¸° ì „ëµ",
        "annual": "ì—°ê°„ ì „ëµ",
    }
    label = type_labels.get(report_type, report_type)
    safe_date = datetime.now().strftime("%Y-%m-%d")
    subject = f"[Strategic Council] {label} | {safe_date}"

    email_content = f"""From: {EMAIL_USER}
To: {EMAIL_RECEIVER}
Subject: {subject}
MIME-Version: 1.0
Content-Type: text/html; charset="utf-8"
Content-Transfer-Encoding: 8bit

<html>
<head>
    <style>
        body {{ font-family: 'Helvetica Neue', Arial, sans-serif; line-height: 1.7; color: #333; max-width: 860px; margin: 0 auto; padding: 20px; }}
        h3 {{ border-bottom: 2px solid #333; padding-bottom: 5px; margin-top: 30px; }}
        li {{ margin-bottom: 8px; }}
        table {{ width: 100%; border-collapse: collapse; margin-top: 10px; }}
        th, td {{ border: 1px solid #ddd; padding: 8px; text-align: left; }}
        th {{ background-color: #f2f2f2; }}
    </style>
</head>
<body>
<div style="background:#1a1a2e; color:#fff; padding:20px; border-radius:8px; margin-bottom:20px; text-align:center;">
  <h1 style="margin:0;">ğŸŒŒ Strategic Council</h1>
  <p style="margin:5px 0 0 0; font-size:14px; color:#aaa;">{label} | {safe_date} | 2-Tier AI Pipeline (Haikuâ†’Sonnet)</p>
</div>
{report_body}
<br><br>
<hr>
<p style="font-size:11px; color:#999; text-align:center;">
  Generated by Strategic Council AI Pipeline<br>
  Tier-1: Claude Haiku 3.5 (Filtering) â†’ Tier-2: Claude Sonnet 3.5 (Analysis)<br>
  ë¹„ìš© ìµœì í™”: ~90% í† í° ì ˆê°
</p>
</body>
</html>
"""

    if not EMAIL_PASSWORD.isascii():
        print("  [FATAL] ë¹„ë°€ë²ˆí˜¸ì— ë¹„-ASCII ë¬¸ì í¬í•¨")
        return

    try:
        server = smtplib.SMTP(SMTP_SERVER, 587, local_hostname="localhost")
        server.starttls()
        server.login(EMAIL_USER, EMAIL_PASSWORD)
        server.sendmail(EMAIL_USER, EMAIL_RECEIVER, email_content.encode("utf-8"))
        server.quit()
        print("  [OK] ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ")
    except Exception:
        print("  [FATAL] ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨:")
        traceback.print_exc()

# ============================================================
# [6] ìŠ¤ì¼€ì¤„ íŒì • ì—”ì§„
# ============================================================

def determine_report_types(now: datetime = None) -> list[str]:
    """
    í˜„ì¬ ì‹œê° ê¸°ì¤€ìœ¼ë¡œ ìƒì„±í•´ì•¼ í•  ë¦¬í¬íŠ¸ ìœ í˜• ëª©ë¡ì„ ë°˜í™˜.

    ìŠ¤ì¼€ì¤„ ì„¤ê³„:
    - ì¼ê°„: ë§¤ì¼ (í•œêµ­ì¥ ë§ˆê° í›„ KST 16:00 = UTC 07:00, ë¯¸êµ­ì¥ ë§ˆê° í›„ EST 17:00 = UTC 22:00)
    - ì£¼ê°„: ë§¤ì£¼ í† ìš”ì¼
    - ì›”ê°„: ë§¤ì›” 1ì¼
    - ë¶„ê¸°: 1/4/7/10ì›” 1ì¼
    - ë°˜ê¸°: 1/7ì›” 1ì¼
    - ì—°ê°„: 1ì›” 1ì¼

    GitHub Actionsì—ì„œëŠ” cronìœ¼ë¡œ UTC 07:00, UTC 22:00ì— íŠ¸ë¦¬ê±°.
    ì´ í•¨ìˆ˜ëŠ” í•´ë‹¹ ì‹¤í–‰ ì‹œì ì— ì–´ë–¤ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í• ì§€ íŒì •.
    """
    if now is None:
        now = datetime.utcnow()

    reports = ["daily"]  # ì¼ê°„ì€ í•­ìƒ ìƒì„±

    # ì£¼ê°„: í† ìš”ì¼ (weekday 5)
    if now.weekday() == 5:
        reports.append("weekly")

    # ì›”ê°„: ë§¤ì›” 1ì¼
    if now.day == 1:
        reports.append("monthly")

    # ë¶„ê¸°: 1/4/7/10ì›” 1ì¼
    if now.month in (1, 4, 7, 10) and now.day == 1:
        reports.append("quarterly")

    # ë°˜ê¸°: 1/7ì›” 1ì¼
    if now.month in (1, 7) and now.day == 1:
        reports.append("semi_annual")

    # ì—°ê°„: 1ì›” 1ì¼
    if now.month == 1 and now.day == 1:
        reports.append("annual")

    return reports

# ============================================================
# [7] ëˆ„ì  ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬
# ============================================================

def get_accumulated_context(report_type: str, history: dict) -> str:
    """
    ìƒìœ„ ì£¼ê¸° ë¦¬í¬íŠ¸ ìƒì„± ì‹œ, í•˜ìœ„ ì£¼ê¸° ë¦¬í¬íŠ¸ ìš”ì•½ì„ ì»¨í…ìŠ¤íŠ¸ë¡œ ì œê³µ.
    - weekly â†’ ìµœê·¼ 7ì¼ daily ìš”ì•½
    - monthly â†’ ìµœê·¼ 4ì£¼ weekly ìš”ì•½
    - quarterly â†’ ìµœê·¼ 3ê°œì›” monthly ìš”ì•½
    - semi_annual â†’ ìµœê·¼ 2ë¶„ê¸° quarterly ìš”ì•½
    - annual â†’ ìµœê·¼ 2ë°˜ê¸° semi_annual ìš”ì•½
    """
    context_map = {
        "weekly": ("daily", 7),
        "monthly": ("weekly", 4),
        "quarterly": ("monthly", 3),
        "semi_annual": ("quarterly", 2),
        "annual": ("semi_annual", 2),
    }

    if report_type not in context_map:
        return ""

    source_type, count = context_map[report_type]
    entries = history.get(source_type, [])[-count:]

    if not entries:
        return ""

    context = f"[ìµœê·¼ {len(entries)}ê±´ì˜ {source_type} ë¦¬í¬íŠ¸ ìš”ì•½]\n"
    for entry in entries:
        context += f"- {entry.get('date', 'N/A')}: {entry.get('summary', 'N/A')}\n"

    return context

def save_report_summary(report_type: str, report_body: str, history: dict, client: anthropic.Anthropic):
    """ë¦¬í¬íŠ¸ ë³¸ë¬¸ì„ 3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ì—¬ íˆìŠ¤í† ë¦¬ì— ì €ì¥."""
    try:
        response = client.messages.create(
            model="claude-haiku-4-5-20241022",
            max_tokens=300,
            messages=[{
                "role": "user",
                "content": f"ë‹¤ìŒ íˆ¬ì ë¦¬í¬íŠ¸ë¥¼ í•µì‹¬ 3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•˜ì„¸ìš”. í•œêµ­ì–´ë¡œ:\n\n{report_body[:3000]}",
            }],
        )
        summary = response.content[0].text.strip()
    except Exception:
        summary = "ìš”ì•½ ìƒì„± ì‹¤íŒ¨"

    entry = {
        "date": datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC"),
        "summary": summary,
    }

    if report_type not in history:
        history[report_type] = []
    history[report_type].append(entry)

    # íˆìŠ¤í† ë¦¬ í¬ê¸° ì œí•œ (ê° ìœ í˜•ë³„ ìµœëŒ€ ë³´ê´€)
    limits = {"daily": 30, "weekly": 12, "monthly": 12, "quarterly": 8, "semi_annual": 4, "annual": 3}
    max_entries = limits.get(report_type, 10)
    history[report_type] = history[report_type][-max_entries:]

# ============================================================
# [8] ë©”ì¸ íŒŒì´í”„ë¼ì¸
# ============================================================

def main():
    print("=" * 60)
    print("  STRATEGIC COUNCIL â€” 2-Tier AI Pipeline")
    print(f"  Execution Time: {datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')}")
    print("=" * 60)

    # í™˜ê²½ë³€ìˆ˜ ê²€ì¦
    if not ANTHROPIC_API_KEY:
        print("[FATAL] ANTHROPIC_API_KEY ë¯¸ì„¤ì •")
        return
    if not all([EMAIL_USER, EMAIL_PASSWORD, EMAIL_RECEIVER]):
        print("[FATAL] ì´ë©”ì¼ í™˜ê²½ë³€ìˆ˜ ë¯¸ì„¤ì •")
        return

    # Anthropic í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    client = anthropic.Anthropic(api_key=ANTHROPIC_API_KEY)

    # ë¦¬í¬íŠ¸ ìœ í˜• íŒì •
    report_types = determine_report_types()
    print(f"\n[SCHEDULE] ìƒì„± ëŒ€ìƒ ë¦¬í¬íŠ¸: {report_types}")

    # íˆìŠ¤í† ë¦¬ ë¡œë“œ
    history = load_history()

    # Phase 1: RSS ìˆ˜ì§‘
    news_list = fetch_news()
    if not news_list:
        print("[FATAL] ë‰´ìŠ¤ ìˆ˜ì§‘ ì‹¤íŒ¨")
        return

    # Phase 2: Tier-1 Haiku í•„í„°ë§
    top_news = tier1_filter(news_list, client)
    if not top_news:
        print("[FATAL] í•„í„°ë§ ê²°ê³¼ ì—†ìŒ")
        return

    # Phase 3 & 4: ê° ë¦¬í¬íŠ¸ ìœ í˜•ë³„ Tier-2 ë¶„ì„ + ë°œì†¡
    for report_type in report_types:
        try:
            accumulated_context = get_accumulated_context(report_type, history)
            report_body = tier2_analyze(top_news, report_type, client, accumulated_context)

            if report_body and "ë¶„ì„ ì˜¤ë¥˜" not in report_body:
                send_email(report_body, report_type)
                save_report_summary(report_type, report_body, history, client)
                print(f"  [{report_type}] ì™„ë£Œ")
            else:
                print(f"  [{report_type}] ë¶„ì„ ì‹¤íŒ¨")
                print(report_body)
        except Exception as e:
            print(f"  [{report_type}] íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜: {e}")
            traceback.print_exc()

    # íˆìŠ¤í† ë¦¬ ì €ì¥
    save_history(history)
    print("\n[DONE] ì „ì²´ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ")

if __name__ == "__main__":
    main()